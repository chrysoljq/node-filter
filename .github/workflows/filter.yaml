name: Daily Node Filter

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      mode:
        description: '检测模式'
        required: false
        type: choice
        default: 'precise'
        options:
          - precise
          - fast

env:
  PYTHON_VERSION: '3.12'

# Secrets 需要设置:
#   WORKER_URL       — Worker 地址 (https://sub-worker.xxx.workers.dev)
#   WORKER_AUTH_TOKEN — 管理 API 令牌
#   WORKER_SUB_TOKEN — 订阅获取令牌 (可选，仅备用直接拉取时用)

jobs:
  filter:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install -q -r requirements.txt

      - name: Download latest mihomo
        if: ${{ github.event_name == 'schedule' || github.event.inputs.mode != 'fast' }}
        run: |
          MIHOMO_VERSION=$(curl -sL https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "Downloading mihomo ${MIHOMO_VERSION}..."
          curl -sL -o mihomo.gz "https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          gunzip mihomo.gz
          chmod +x mihomo
          sudo mv mihomo /usr/local/bin/mihomo
          mihomo -v

      - name: Fetch subscriptions from Worker
        env:
          WORKER_URL: ${{ secrets.WORKER_URL }}
          WORKER_AUTH_TOKEN: ${{ secrets.WORKER_AUTH_TOKEN }}
        run: |
          mkdir -p /tmp/subs

          echo "从 Worker /api/fetch 获取订阅内容..."
          RESP=$(curl -sf "${WORKER_URL}/api/fetch?token=${WORKER_AUTH_TOKEN}")
          if [ $? -ne 0 ]; then
            echo "::error::Worker API 请求失败"
            exit 1
          fi

          echo "$RESP" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          if not data.get('ok'):
              print('::error::Worker 返回错误')
              sys.exit(1)
          contents = data.get('contents', [])
          count = 0
          for i, c in enumerate(contents):
              if c.strip():
                  with open(f'/tmp/subs/sub_{i}.yaml', 'w') as f:
                      f.write(c)
                  count += 1
          if data.get('errors'):
              for e in data['errors']:
                  print(f'::warning::{e}')
          print(f'获取到 {count} 个有效订阅')
          if count == 0:
              print('::error::没有有效订阅内容')
              sys.exit(1)
          "

      - name: Run filter
        env:
          MODE: ${{ github.event.inputs.mode || 'precise' }}
        run: |
          ARGS=""
          for f in /tmp/subs/sub_*.yaml; do
            [ -f "$f" ] && ARGS="$ARGS -f $f"
          done
          if [ "$MODE" != "fast" ]; then
            ARGS="$ARGS --test"
          fi
          python3 main.py $ARGS

      - name: Show report
        run: cat output/filter_report.md

      - name: Upload config to Worker
        env:
          WORKER_URL: ${{ secrets.WORKER_URL }}
          WORKER_AUTH_TOKEN: ${{ secrets.WORKER_AUTH_TOKEN }}
        run: |
          echo "上传筛选结果到 Worker..."
          RESP=$(curl -sf -X PUT \
            "${WORKER_URL}/api/config?token=${WORKER_AUTH_TOKEN}" \
            -H "Content-Type: text/yaml" \
            --data-binary @output/filtered_config.yaml)

          echo "$RESP" | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          if data.get('ok'):
              info = data.get('data', {})
              print(f'上传成功: {info.get(\"size\", 0)} bytes @ {info.get(\"updatedAt\", \"\")}')
          else:
              print(f'::error::上传失败: {data.get(\"error\", \"unknown\")}')
              sys.exit(1)
          "
